name: Check Flutter Version

on:
  schedule:
    # æ¯ 6 å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ–°ç‰ˆæœ¬ï¼ˆUTC 0:00, 6:00, 12:00, 18:00ï¼‰
    - cron: '0 */6 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-version:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Check Flutter latest stable version
      id: check
      run: |
        echo "æ­£åœ¨æ£€æŸ¥ Flutter æœ€æ–°ç‰ˆæœ¬..."
        
        # è·å– Flutter æœ€æ–°ç¨³å®šç‰ˆæœ¬
        LATEST_VERSION=$(curl -sL https://api.github.com/repos/flutter/flutter/releases/latest | jq -r .tag_name)
        echo "Latest Flutter version: $LATEST_VERSION"
        echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„ SO æ–‡ä»¶
        SO_FILE="lib/libflutter_linux_gtk.so.$LATEST_VERSION"
        if [ -f "$SO_FILE" ]; then
          echo "âœ… Version $LATEST_VERSION already exists"
          echo "build_needed=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ†• New version detected: $LATEST_VERSION"
          echo "build_needed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Trigger build workflow
      if: steps.check.outputs.build_needed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          console.log('è§¦å‘æ„å»ºå·¥ä½œæµ: Flutter ${{ steps.check.outputs.latest_version }}');
          
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'build-flutter-engine.yml',
            ref: 'main',
            inputs: {
              version: '${{ steps.check.outputs.latest_version }}'
            }
          });
          
          console.log('âœ… æ„å»ºå·¥ä½œæµå·²è§¦å‘');
    
    - name: Create issue for manual build (fallback)
      if: steps.check.outputs.build_needed == 'true' && failure()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸ†• New Flutter version detected: ${{ steps.check.outputs.latest_version }}',
            body: `æ£€æµ‹åˆ°æ–°çš„ Flutter ç‰ˆæœ¬ **${{ steps.check.outputs.latest_version }}**
            
            è¯·æ‰‹åŠ¨è§¦å‘æ„å»ºå·¥ä½œæµï¼š
            1. è¿›å…¥ [Actions](https://github.com/${{ github.repository }}/actions/workflows/build-flutter-engine.yml)
            2. ç‚¹å‡» "Run workflow"
            3. è¾“å…¥ç‰ˆæœ¬å·: \`${{ steps.check.outputs.latest_version }}\`
            4. ç‚¹å‡» "Run workflow" æŒ‰é’®
            
            æˆ–è€…ä½¿ç”¨è‡ªæ‰˜ç®¡ Runner è§¦å‘ [build-flutter-engine-self-hosted.yml](https://github.com/${{ github.repository }}/actions/workflows/build-flutter-engine-self-hosted.yml)`,
            labels: ['enhancement', 'auto-build']
          });
