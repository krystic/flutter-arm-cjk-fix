name: Check Flutter Version

on:
  schedule:
    # æ¯ 6 å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ–°ç‰ˆæœ¬ï¼ˆUTC 0:00, 6:00, 12:00, 18:00ï¼‰
    - cron: '0 */6 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Check Flutter latest engine version from source
      id: check
      run: |
        echo "æ­£åœ¨æ£€æŸ¥ Flutter Engine æœ€æ–°ç‰ˆæœ¬ï¼ˆä» Git tagsï¼‰..."
        
        # æ–¹æ³•1: ä» GitHub API è·å–æœ€æ–°çš„ stable tag
        echo "å°è¯•ä» GitHub API è·å–æœ€æ–° tag..."
        LATEST_TAG=$(curl -sL https://api.github.com/repos/flutter/flutter/tags | \
          jq -r '.[].name' | \
          grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | \
          sort -V | \
          tail -n1)
        
        if [ -z "$LATEST_TAG" ]; then
          echo "âŒ æ— æ³•ä» API è·å– tagï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•..."
          # æ–¹æ³•2: ä» Git ä»“åº“ç›´æ¥è·å– tagsï¼ˆå¤‡ç”¨ï¼‰
          LATEST_TAG=$(git ls-remote --tags https://github.com/flutter/flutter.git | \
            grep -o 'refs/tags/[0-9]*\.[0-9]*\.[0-9]*$' | \
            sed 's|refs/tags/||' | \
            sort -V | \
            tail -n1)
        fi
        
        if [ -z "$LATEST_TAG" ]; then
          echo "âŒ æ— æ³•è·å– Flutter ç‰ˆæœ¬"
          exit 1
        fi
        
        echo "æœ€æ–° Flutter ç‰ˆæœ¬: $LATEST_TAG"
        FLUTTER_VERSION="$LATEST_TAG"

        # é€šè¿‡ GitHub API è·å–è¯¥ Flutter ç‰ˆæœ¬å¯¹åº”çš„æäº¤ SHAï¼ˆtag æŒ‡å‘çš„å¯¹è±¡ï¼‰
        echo "è·å– Flutter æäº¤ SHA (refs/tags/$LATEST_TAG)..."
        FLUTTER_COMMIT_SHA=$(curl -s "https://api.github.com/repos/flutter/flutter/git/ref/tags/$LATEST_TAG" | jq -r '.object.sha')
        if [ -z "$FLUTTER_COMMIT_SHA" ] || [ "$FLUTTER_COMMIT_SHA" = "null" ]; then
          echo "API è·¯å¾„ git/ref å¯èƒ½ä¸å¯ç”¨ï¼Œå°è¯• git/refs å¤‡ç”¨è·¯å¾„..."
          FLUTTER_COMMIT_SHA=$(curl -s "https://api.github.com/repos/flutter/flutter/git/refs/tags/$LATEST_TAG" | jq -r '.object.sha')
        fi
        if [ -z "$FLUTTER_COMMIT_SHA" ] || [ "$FLUTTER_COMMIT_SHA" = "null" ]; then
          echo "âŒ æ— æ³•è·å– Flutter æäº¤ SHA"
          exit 1
        fi
        
        # åŸºäºè¿™ä¸ª tag è·å–å¯¹åº”çš„ Engine commit
        echo "è·å– Engine commit (ä» tag $LATEST_TAG)..."
        ENGINE_COMMIT=$(curl -sL "https://raw.githubusercontent.com/flutter/flutter/$LATEST_TAG/bin/internal/engine.version" | tr -d '[:space:]')
        
        if [ -z "$ENGINE_COMMIT" ]; then
          echo "âŒ æ— æ³•è·å– Engine commit"
          exit 1
        fi
        
        echo "Flutter SDK version: $FLUTTER_VERSION"
        echo "Flutter commit: $FLUTTER_COMMIT_SHA"
        echo "Engine commit: $ENGINE_COMMIT"
        
        echo "latest_version=$FLUTTER_VERSION" >> $GITHUB_OUTPUT
        echo "flutter_commit=$FLUTTER_COMMIT_SHA" >> $GITHUB_OUTPUT
        echo "engine_commit=$ENGINE_COMMIT" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„ SO æ–‡ä»¶
        SO_FILE="lib/libflutter_linux_gtk.so.$FLUTTER_VERSION"
        if [ -f "$SO_FILE" ]; then
          echo "âœ… Version $FLUTTER_VERSION already exists (Engine: $ENGINE_COMMIT)"
          echo "build_needed=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ†• New version detected: $FLUTTER_VERSION (Engine: $ENGINE_COMMIT)"
          echo "build_needed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Trigger build workflow
      if: steps.check.outputs.build_needed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          console.log('è§¦å‘æ„å»ºå·¥ä½œæµ: Flutter ${{ steps.check.outputs.latest_version }} (Flutter commit: ${{ steps.check.outputs.flutter_commit }}, Engine: ${{ steps.check.outputs.engine_commit }})');
          
          await github.rest.repos.createDispatchEvent({
            owner: context.repo.owner,
            repo: context.repo.repo,
            event_type: 'build-flutter-engine',
            client_payload: {
              flutter_version: '${{ steps.check.outputs.latest_version }}',
              flutter_commit: '${{ steps.check.outputs.flutter_commit }}',
              engine_commit: '${{ steps.check.outputs.engine_commit }}'
            }
          });
          
          console.log('âœ… æ„å»ºå·¥ä½œæµå·²è§¦å‘');
    
    - name: Create issue for manual build (fallback)
      if: steps.check.outputs.build_needed == 'true' && failure()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸ†• New Flutter version detected: ${{ steps.check.outputs.latest_version }}',
            body: `æ£€æµ‹åˆ°æ–°çš„ Flutter ç‰ˆæœ¬ **${{ steps.check.outputs.latest_version }}**
            
            Flutter æäº¤: \\`${{ steps.check.outputs.flutter_commit }}\\`
            Engine æäº¤: \\`${{ steps.check.outputs.engine_commit }}\\`

            è¯·æ‰‹åŠ¨è§¦å‘æ„å»ºå·¥ä½œæµï¼š
            1. è¿›å…¥ [Actions](https://github.com/${{ github.repository }}/actions/workflows/build-flutter-engine.yml)
            2. ç‚¹å‡» "Run workflow"
            3. è¾“å…¥ç‰ˆæœ¬å·: \`${{ steps.check.outputs.latest_version }}\`
            4. ç‚¹å‡» "Run workflow" æŒ‰é’®
            
            æˆ–è€…ä½¿ç”¨è‡ªæ‰˜ç®¡ Runner è§¦å‘ [build-flutter-engine-self-hosted.yml](https://github.com/${{ github.repository }}/actions/workflows/build-flutter-engine-self-hosted.yml)`,
            labels: ['enhancement', 'auto-build']
          });
