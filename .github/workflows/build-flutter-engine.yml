name: Build Flutter Engine (with Cache)

on:
  workflow_dispatch:
    inputs:
      flutter_version:
        description: 'Flutter SDK version (e.g., 3.24.3)'
        required: true
        type: string
      flutter_commit:
        description: 'Flutter repo commit SHA (optional; recommended)'
        required: false
        type: string
  
  repository_dispatch:
    types: [build-flutter-engine]

env:
  DEPOT_TOOLS_DIR: ${{ github.workspace }}/depot_tools
  ENGINE_DIR: ${{ github.workspace }}/flutter-engine

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 å°æ—¶è¶…æ—¶é™åˆ¶
    
    steps:
    - name: Set input variables
      id: set-vars
      run: |
        # å¤„ç†ä¸¤ç§è§¦å‘æ–¹å¼çš„è¾“å…¥å‚æ•°
        if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          echo "flutter_version=${{ github.event.client_payload.flutter_version }}" >> $GITHUB_OUTPUT
          echo "flutter_commit=${{ github.event.client_payload.flutter_commit }}" >> $GITHUB_OUTPUT
        else
          echo "flutter_version=${{ inputs.flutter_version }}" >> $GITHUB_OUTPUT
          echo "flutter_commit=${{ inputs.flutter_commit }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Free up disk space
      run: |
        echo "æ¸…ç†ç£ç›˜ç©ºé—´..."
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        df -h
    
    - name: Setup build environment
      run: |
        echo "å®‰è£…ç¼–è¯‘ä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          git curl unzip xz-utils zip \
          libglu1-mesa ninja-build \
          clang cmake pkg-config \
          libgtk-3-dev libblkid-dev \
          liblzma-dev libgcrypt20-dev \
          libfontconfig1-dev \
          python3 python3-pip \
          jq
        
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
    
    - name: Cache depot_tools
      id: cache-depot-tools
      uses: actions/cache@v4
      with:
        path: ${{ env.DEPOT_TOOLS_DIR }}
        key: depot-tools-${{ runner.os }}-v1
        restore-keys: |
          depot-tools-${{ runner.os }}-
    
    - name: Setup depot_tools
      if: steps.cache-depot-tools.outputs.cache-hit != 'true'
      run: |
        echo "å…‹éš† depot_tools..."
        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$DEPOT_TOOLS_DIR"
    
    - name: Add depot_tools to PATH
      run: |
        echo "$DEPOT_TOOLS_DIR" >> $GITHUB_PATH
        echo "âœ… depot_tools å·²æ·»åŠ åˆ° PATH"
    
    - name: Resolve Flutter revision
      id: resolve-rev
      run: |
        REVISION="${{ steps.set-vars.outputs.flutter_commit }}"
        if [ -z "$REVISION" ] || [ "$REVISION" = "null" ]; then
          echo "æ ¹æ®ç‰ˆæœ¬è§£æ Flutter æäº¤..."
          REVISION=$(curl -s "https://api.github.com/repos/flutter/flutter/git/ref/tags/${{ steps.set-vars.outputs.flutter_version }}" | jq -r '.object.sha')
          if [ -z "$REVISION" ] || [ "$REVISION" = "null" ]; then
            REVISION=$(curl -s "https://api.github.com/repos/flutter/flutter/git/refs/tags/${{ steps.set-vars.outputs.flutter_version }}" | jq -r '.object.sha')
          fi
        fi
        if [ -z "$REVISION" ] || [ "$REVISION" = "null" ]; then
          echo "âŒ æ— æ³•è§£æ Flutter æäº¤"
          exit 1
        fi
        echo "revision=$REVISION" >> $GITHUB_OUTPUT
        echo "REVISION=$REVISION" >> $GITHUB_ENV
    
    - name: Cache Flutter Engine source
      id: cache-engine-src
      uses: actions/cache@v4
      with:
        path: ${{ env.ENGINE_DIR }}
        key: flutter-engine-src-${{ steps.resolve-rev.outputs.revision }}-v1
        restore-keys: |
          flutter-engine-src-${{ steps.resolve-rev.outputs.revision }}-
          flutter-engine-src-
    
    - name: Clone Flutter Engine
      run: |
        echo "å‡†å¤‡ Flutter Engine æºç ..."
        mkdir -p "$ENGINE_DIR"
        cd "$ENGINE_DIR"
        
        # å…‹éš† Flutter ä¸»ä»“åº“åˆ°å½“å‰ç›®å½•
        echo "å…‹éš† flutter/flutter..."
        git clone https://github.com/flutter/flutter.git .
        
        echo "åˆ‡æ¢åˆ°ä¿®è®¢ $REVISION (tag: ${{ steps.set-vars.outputs.flutter_version }})..."
        git checkout $REVISION
        
        # å¤åˆ¶ gclient é…ç½®æ–‡ä»¶
        echo "é…ç½® gclient..."
        cp engine/scripts/standard.gclient .gclient
        
        echo "åŒæ­¥ DEPS ä¾èµ–..."
        # è®¾ç½® Git é…ç½®é¿å…è­¦å‘Š
        export GIT_CONFIG_COUNT=1
        export GIT_CONFIG_KEY_0=protocol.file.allow
        export GIT_CONFIG_VALUE_0=always
        
        gclient sync --verbose
        
        echo "âœ… æºç åŒæ­¥å®Œæˆ"
        df -h
    
    - name: Modify GN configuration for fontconfig
      run: |
        echo "ä¿®æ”¹ GN é…ç½®ä»¥å¯ç”¨ fontconfig..."
        cd "$ENGINE_DIR"
        
        # ç¡®ä¿ GN å‚æ•°ä¸­åŒ…å« fontconfig æ”¯æŒ
        # è¿™ä¼šåœ¨åç»­çš„ gn å‘½ä»¤ä¸­é€šè¿‡ --enable-fontconfig ä¼ é€’
        
        echo "âœ… é…ç½®å·²å‡†å¤‡"
    
    - name: Generate build files with fontconfig
      run: |
        echo "ç”Ÿæˆæ„å»ºé…ç½®..."
        cd "$ENGINE_DIR"
        
        ./tools/gn \
          --target-os linux \
          --linux-cpu arm64 \
          --runtime-mode release \
          --enable-fontconfig \
          --no-goma \
          --no-prebuilt-dart-sdk
        
        echo "âœ… æ„å»ºé…ç½®ç”Ÿæˆå®Œæˆ"
        ls -la out/linux_release_arm64/
    
    - name: Build Flutter Engine
      run: |
        echo "å¼€å§‹ç¼–è¯‘ Flutter Engine..."
        cd "$ENGINE_DIR"
        
        # ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„ CPU æ ¸å¿ƒ
        JOBS=$(nproc)
        echo "ä½¿ç”¨ $JOBS ä¸ªå¹¶è¡Œä»»åŠ¡"
        
        ninja -C out/linux_release_arm64 -j $JOBS
        
        echo "âœ… ç¼–è¯‘å®Œæˆ"
    
    - name: Extract and verify SO file
      run: |
        VERSION="${{ steps.set-vars.outputs.flutter_version }}"
        SO_SOURCE="$ENGINE_DIR/out/linux_release_arm64/libflutter_linux_gtk.so"
        SO_DEST="lib/libflutter_linux_gtk.so.$VERSION"
        
        echo "æå– SO æ–‡ä»¶..."
        mkdir -p lib
        cp "$SO_SOURCE" "$SO_DEST"
        
        echo "æ–‡ä»¶ä¿¡æ¯ï¼š"
        file "$SO_DEST"
        ls -lh "$SO_DEST"
        
        echo "éªŒè¯ fontconfig é“¾æ¥ï¼š"
        if readelf -d "$SO_DEST" | grep -q fontconfig; then
          echo "âœ… fontconfig å·²æ­£ç¡®é“¾æ¥"
          readelf -d "$SO_DEST" | grep fontconfig
        else
          echo "âŒ è­¦å‘Š: æœªæ‰¾åˆ° fontconfig é“¾æ¥"
          readelf -d "$SO_DEST" | head -20
          exit 1
        fi
    
    - name: Update lib README
      run: |
        VERSION="${{ steps.set-vars.outputs.flutter_version }}"
        FLUTTER_COMMIT="${{ steps.set-vars.outputs.flutter_commit }}"
        SIZE=$(du -h "lib/libflutter_linux_gtk.so.$VERSION" | cut -f1)
        
        cat >> lib/README.md << __EOF__

        ## Flutter $VERSION
        - Flutter Commit: ${FLUTTER_COMMIT:-N/A}
        - Built on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - Size: $SIZE
        - Platform: Linux ARM64
        - Build Type: Release
        - Features: Fontconfig enabled
        - Built by: GitHub Actions

        __EOF__
        
        echo "âœ… README å·²æ›´æ–°"
    
    - name: Commit and push
      run: |
        VERSION="${{ steps.set-vars.outputs.flutter_version }}"
        FLUTTER_COMMIT="${{ steps.set-vars.outputs.flutter_commit }}"
        
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add lib/
        SIZE=$(du -h lib/libflutter_linux_gtk.so.$VERSION | cut -f1)
        git commit -m "chore: add Flutter Engine $VERSION with fontconfig support" \
          -m "Built from flutter/flutter@${FLUTTER_COMMIT}" \
          -m "Added --enable-fontconfig flag" \
          -m "Linux ARM64 release build" \
          -m "Auto-built by GitHub Actions" \
          -m "Size: $SIZE" || echo "No changes to commit"
        
        git push
        
        echo "âœ… å·²æ¨é€åˆ°ä»“åº“"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: flutter-${{ steps.set-vars.outputs.flutter_version }}
        name: Flutter Engine ${{ steps.set-vars.outputs.flutter_version }} (ARM64 + Fontconfig)
        body: |
          ## ğŸš€ Flutter Engine with Fontconfig Support
          
          **Flutter SDK Version**: ${{ steps.set-vars.outputs.flutter_version }}  
          **Flutter Commit**: ${{ steps.set-vars.outputs.flutter_commit }}  
          **Platform**: Linux ARM64  
          **Build Type**: Release  
          **Special Features**: Compiled with `--enable-fontconfig` to fix CJK font rendering
          
          ### ğŸ“¦ What's Included
          - `libflutter_linux_gtk.so.${{ steps.set-vars.outputs.flutter_version }}` - Flutter Engine shared library
          
          ### âœ… Verification
          This build includes fontconfig support, verified by:
          ```bash
          readelf -d libflutter_linux_gtk.so.${{ steps.set-vars.outputs.flutter_version }} | grep fontconfig
          # Expected output: libfontconfig.so.1
          ```
          
          ### ğŸ“¥ Usage
          ```bash
          # Download and use with flutter-font-fix tool
          sudo flutter-font-fix -a <your-flutter-app>
          ```
          
          ### ğŸ”— Related
          - Original issue: CJK characters displaying as squares (â–¡â–¡â–¡) on Linux ARM64
          - Root cause: Official Flutter Engine lacks fontconfig support on ARM64
          - Solution: This custom build with fontconfig enabled
          - Source: https://github.com/flutter/flutter/commit/${{ steps.set-vars.outputs.flutter_commit }}
          
          ---
          **Auto-built by GitHub Actions** on $(date -u '+%Y-%m-%d')
        files: |
          lib/libflutter_linux_gtk.so.${{ steps.set-vars.outputs.flutter_version }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Cleanup
      if: always()
      run: |
        echo "æ¸…ç†æ„å»ºæ–‡ä»¶..."
        df -h
        # ä¿ç•™ç¼“å­˜ï¼Œåªæ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf "$ENGINE_DIR/out/linux_release_arm64/obj" || true
        echo "âœ… æ¸…ç†å®Œæˆ"
