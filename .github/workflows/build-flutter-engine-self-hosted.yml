name: Build Flutter Engine (Self-Hosted Runner)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Flutter version to build (e.g., 3.24.3)'
        required: true
        type: string
      flutter_commit:
        description: 'Flutter repo commit SHA (optional)'
        required: false
        type: string
  schedule:
    # æ¯å¤© UTC 2:00 æ£€æŸ¥å¹¶æ„å»ºï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'

env:
  DEPOT_TOOLS_DIR: ${{ github.workspace }}/depot_tools
  ENGINE_DIR: ${{ github.workspace }}/flutter-engine

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      build_needed: ${{ steps.check.outputs.build_needed }}
      version: ${{ steps.check.outputs.version }}
      flutter_commit: ${{ steps.check.outputs.flutter_commit }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check if build needed
      id: check
      run: |
        # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬
        if [ -n "${{ inputs.version }}" ]; then
          VERSION="${{ inputs.version }}"
        else
          # å®šæ—¶ä»»åŠ¡ï¼šè·å–æœ€æ–°ç‰ˆæœ¬
          VERSION=$(curl -sL https://api.github.com/repos/flutter/flutter/releases/latest | jq -r .tag_name)
        fi
        
        echo "Checking version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        # è·å– Flutter commitï¼ˆtags/<version> çš„å¯¹è±¡ SHAï¼‰
        if [ -n "${{ inputs.flutter_commit }}" ]; then
          FLUTTER_COMMIT="${{ inputs.flutter_commit }}"
        else
          FLUTTER_COMMIT=$(curl -s "https://api.github.com/repos/flutter/flutter/git/ref/tags/$VERSION" | jq -r '.object.sha')
          if [ -z "$FLUTTER_COMMIT" ] || [ "$FLUTTER_COMMIT" = "null" ]; then
            FLUTTER_COMMIT=$(curl -s "https://api.github.com/repos/flutter/flutter/git/refs/tags/$VERSION" | jq -r '.object.sha')
          fi
        fi
        echo "flutter_commit=$FLUTTER_COMMIT" >> $GITHUB_OUTPUT

        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        SO_FILE="lib/libflutter_linux_gtk.so.$VERSION"
        if [ -f "$SO_FILE" ]; then
          echo "build_needed=false" >> $GITHUB_OUTPUT
          echo "âœ… Version $VERSION already exists"
        else
          echo "build_needed=true" >> $GITHUB_OUTPUT
          echo "ğŸ†• Need to build version: $VERSION"
        fi

  build:
    needs: check-version
    if: needs.check-version.outputs.build_needed == 'true'
    runs-on: self-hosted  # ä½¿ç”¨è‡ªæ‰˜ç®¡çš„ ARM Linux æœºå™¨
    timeout-minutes: 180  # 3 å°æ—¶è¶…æ—¶ï¼ˆè‡ªæ‰˜ç®¡é€šå¸¸æ›´å¿«ï¼‰
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check system info
      run: |
        echo "ç³»ç»Ÿä¿¡æ¯ï¼š"
        uname -a
        echo ""
        echo "CPU ä¿¡æ¯ï¼š"
        lscpu | grep -E "Architecture|CPU\(s\)|Model name"
        echo ""
        echo "å†…å­˜ä¿¡æ¯ï¼š"
        free -h
        echo ""
        echo "ç£ç›˜ç©ºé—´ï¼š"
        df -h
    
    - name: Install dependencies
      run: |
        echo "å®‰è£…/æ›´æ–°ç¼–è¯‘ä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          git curl unzip xz-utils zip \
          libglu1-mesa ninja-build \
          clang cmake pkg-config \
          libgtk-3-dev libblkid-dev \
          liblzma-dev libgcrypt20-dev \
          libfontconfig1-dev \
          python3 python3-pip \
          jq
        
        echo "âœ… ä¾èµ–å·²å‡†å¤‡"
    
    - name: Setup depot_tools
      run: |
        if [ ! -d "$DEPOT_TOOLS_DIR" ]; then
          echo "å…‹éš† depot_tools..."
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git "$DEPOT_TOOLS_DIR"
        else
          echo "æ›´æ–° depot_tools..."
          cd "$DEPOT_TOOLS_DIR"
          git pull
        fi
        
        echo "$DEPOT_TOOLS_DIR" >> $GITHUB_PATH
    
    - name: Prepare Flutter Engine workspace
      run: |
        echo "å‡†å¤‡ Flutter Engine å·¥ä½œç©ºé—´..."
        mkdir -p "$ENGINE_DIR"
        cd "$ENGINE_DIR"
        
        # åˆ›å»º .gclient é…ç½®
        cat > .gclient << '__EOF__'
        solutions = [
          {
            "managed": False,
            "name": "src/flutter",
            "url": "https://github.com/flutter/flutter.git",
            "custom_deps": {},
            "deps_file": "DEPS",
            "safesync_url": "",
          },
        ]
        __EOF__
        
        echo "âœ… å·¥ä½œç©ºé—´å·²å‡†å¤‡"
    
    - name: Sync Flutter Engine source
      run: |
        VERSION="${{ needs.check-version.outputs.version }}"
        FLUTTER_COMMIT="${{ needs.check-version.outputs.flutter_commit }}"
        REVISION="$FLUTTER_COMMIT"
        if [ -z "$REVISION" ]; then
          REVISION="$VERSION"
        fi
        echo "åŒæ­¥ Flutter æºç åˆ°ä¿®è®¢ $REVISION..."
        cd "$ENGINE_DIR"
        
        # è®¾ç½® Git é…ç½®
        export GIT_CONFIG_COUNT=1
        export GIT_CONFIG_KEY_0=protocol.file.allow
        export GIT_CONFIG_VALUE_0=always
        
        # åŒæ­¥åˆ°æŒ‡å®šä¿®è®¢ï¼ˆä¼˜å…ˆä½¿ç”¨ commitï¼Œå…¶æ¬¡ tag ç‰ˆæœ¬ï¼‰
        gclient sync --revision="$REVISION" --verbose
        
        echo "âœ… æºç åŒæ­¥å®Œæˆ"
    
    - name: Configure build with fontconfig
      run: |
        echo "é…ç½®æ„å»ºå‚æ•°ï¼ˆå¯ç”¨ fontconfigï¼‰..."
        cd "$ENGINE_DIR/src"
        
        ./flutter/tools/gn \
          --target-os linux \
          --linux-cpu arm64 \
          --runtime-mode release \
          --enable-fontconfig \
          --no-goma \
          --no-prebuilt-dart-sdk
        
        echo "âœ… æ„å»ºé…ç½®å®Œæˆ"
    
    - name: Build Flutter Engine
      run: |
        echo "å¼€å§‹ç¼–è¯‘ Flutter Engine..."
        cd "$ENGINE_DIR/src"
        
        # è‡ªæ‰˜ç®¡æœºå™¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰æ ¸å¿ƒ
        JOBS=$(nproc)
        echo "ä½¿ç”¨ $JOBS ä¸ªå¹¶è¡Œä»»åŠ¡ç¼–è¯‘"
        
        time ninja -C out/linux_release_arm64 -j $JOBS
        
        echo "âœ… ç¼–è¯‘å®Œæˆ"
    
    - name: Extract and verify SO file
      run: |
        VERSION="${{ needs.check-version.outputs.version }}"
        SO_SOURCE="$ENGINE_DIR/src/out/linux_release_arm64/libflutter_linux_gtk.so"
        SO_DEST="lib/libflutter_linux_gtk.so.$VERSION"
        
        echo "æå–ç¼–è¯‘äº§ç‰©..."
        mkdir -p lib
        cp "$SO_SOURCE" "$SO_DEST"
        
        echo "æ–‡ä»¶ä¿¡æ¯ï¼š"
        file "$SO_DEST"
        ls -lh "$SO_DEST"
        
        echo ""
        echo "éªŒè¯ fontconfig é“¾æ¥ï¼š"
        if readelf -d "$SO_DEST" | grep -q fontconfig; then
          echo "âœ… fontconfig å·²æ­£ç¡®é“¾æ¥"
          readelf -d "$SO_DEST" | grep fontconfig
        else
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° fontconfig é“¾æ¥ï¼"
          echo "å®Œæ•´çš„ä¾èµ–åº“åˆ—è¡¨ï¼š"
          readelf -d "$SO_DEST"
          exit 1
        fi
        
        echo ""
        echo "æ–‡ä»¶å¤§å°ï¼š"
        du -h "$SO_DEST"
    
    - name: Update documentation
      run: |
        VERSION="${{ needs.check-version.outputs.version }}"
        FLUTTER_COMMIT="${{ needs.check-version.outputs.flutter_commit }}"
        SIZE=$(du -h "lib/libflutter_linux_gtk.so.$VERSION" | cut -f1)
        BUILD_HOST=$(hostname)
        BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        cat >> lib/README.md << '__EOF__'

        ## Flutter $VERSION
        - Flutter Commit: ${FLUTTER_COMMIT:-N/A}
        - Built on: $BUILD_TIME
        - Build host: $BUILD_HOST (Self-hosted ARM64 Runner)
        - Size: $SIZE
        - Platform: Linux ARM64
        - Build Type: Release
        - Features: Fontconfig enabled âœ…
        - Verification: `readelf -d libflutter_linux_gtk.so.$VERSION | grep fontconfig`

        __EOF__
        
        echo "âœ… æ–‡æ¡£å·²æ›´æ–°"
    
    - name: Commit and push
      run: |
        VERSION="${{ needs.check-version.outputs.version }}"
        SIZE=$(du -h "lib/libflutter_linux_gtk.so.$VERSION" | cut -f1)
        
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add lib/
        git commit -m "chore: add Flutter Engine $VERSION with fontconfig (self-hosted build)" \
          -m "Version: $VERSION" \
          -m "Platform: Linux ARM64" \
          -m "Build Type: Release" \
          -m "Features: fontconfig enabled" \
          -m "Size: $SIZE" \
          -m "Built on: Self-hosted ARM64 runner" \
          -m "Auto-built by GitHub Actions" || echo "No changes to commit"
        
        git push
        
        echo "âœ… å·²æ¨é€åˆ°ä»“åº“"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: flutter-${{ needs.check-version.outputs.version }}
        name: Flutter Engine ${{ needs.check-version.outputs.version }} (ARM64 + Fontconfig)
        body: |
          ## ğŸš€ Flutter Engine with Fontconfig Support
          
          **Version**: ${{ needs.check-version.outputs.version }}  
          **Flutter Commit**: ${{ needs.check-version.outputs.flutter_commit }}  
          **Platform**: Linux ARM64  
          **Build Type**: Release  
          **Build Environment**: Self-hosted ARM64 Runner  
          **Special Features**: âœ… Fontconfig enabled
          
          ### ğŸ¯ Purpose
          This custom build fixes the CJK character rendering issue (displaying as â–¡â–¡â–¡) on Flutter Linux ARM64 applications.
          
          ### ğŸ“¦ What's New
          - Compiled with `--enable-fontconfig` flag
          - Native ARM64 compilation on self-hosted runner
          - Faster build times compared to cross-compilation
          - Verified fontconfig linkage
          
          ### âœ… Verification
          ```bash
          readelf -d libflutter_linux_gtk.so.${{ needs.check-version.outputs.version }} | grep fontconfig
          # Output should show: libfontconfig.so.1
          ```
          
          ### ğŸ“¥ Installation
          ```bash
          # 1. Download this SO file
          wget https://github.com/${{ github.repository }}/releases/download/flutter-${{ needs.check-version.outputs.version }}/libflutter_linux_gtk.so.${{ needs.check-version.outputs.version }}
          
          # 2. Use with flutter-font-fix tool
          sudo flutter-font-fix -a <your-flutter-snap-app>
          ```
          
          ### ğŸ” Technical Details
          - **Root Cause**: Official Flutter Engine lacks fontconfig support on ARM64
          - **Solution**: Custom compilation with `--enable-fontconfig`
          - **Impact**: Fixes all CJK (Chinese, Japanese, Korean) font rendering issues
          
          ### ğŸ“š Documentation
          - See [FONTCONFIG_BUG_INVESTIGATION.md](https://github.com/${{ github.repository }}/blob/main/FONTCONFIG_BUG_INVESTIGATION.md) for detailed analysis
          - Source: https://github.com/flutter/flutter/commit/${{ needs.check-version.outputs.flutter_commit }}
          
          ---
          **Built on**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
          **Builder**: GitHub Actions (Self-hosted ARM64 Runner)
        files: |
          lib/libflutter_linux_gtk.so.${{ needs.check-version.outputs.version }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Cleanup build artifacts
      if: always()
      run: |
        echo "æ¸…ç†æ„å»ºä¸´æ—¶æ–‡ä»¶ï¼ˆä¿ç•™æºç ç¼“å­˜ï¼‰..."
        rm -rf "$ENGINE_DIR/src/out/linux_release_arm64/obj" || true
        rm -rf "$ENGINE_DIR/src/out/linux_release_arm64/gen" || true
        
        echo "å½“å‰ç£ç›˜ä½¿ç”¨ï¼š"
        df -h
        
        echo "âœ… æ¸…ç†å®Œæˆ"
